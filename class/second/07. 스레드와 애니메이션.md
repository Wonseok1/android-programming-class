# 07. 스레드와 애니메이션

## 07-4 AsyncTask 사용하기

안드로이드에서는 스레드를 만들어서 직접 UI객체를 수정할 수 없다. 그 이유는 네트워크 요청 같이 대기시간이 길어지는 기능을 수행하면 화면에 보이는 UI가 멈춤 상태가 되어버리기 때문이다. 따라서 스레드와 헨들러를 연결하여 간접적으로 UI를 수정하지만, 다소 코드가 복잡해지게 된다. AsyncTask는 백그라운드 작업을 수행하면서 UI를 수정할 수 있는 코드를 정의할 수 있는 장점이 있다. 



- 주요 함수 (클래스)

| 함수                                | 설명                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| doInBackground(Params... params)    | 스레드에 의해 처리될 내용을 담기 위한 함수이다. 작업을 처리하기 전에 isCancelled() 함수의 리턴값을 체크하여 작업의 계속 진행 여부를 확인해야 한다. |
| onPreExecute()                      | AsyncTask의 작업을 시작하기 전에 호출하는 함수,  함수들중 가장 먼저 호출된다. |
| onPostExecute(Result result)        | AsyncTask의 모든 작업이 완료된 후 가장 마지막에 한번 호출되는 함수. doInBackground() 함수의 최종 값을 받기 위해 사용 |
| onProgressUpdate(Progress... value) | doInBackground() 함수에 의해 처리되는 중간중간 값을 받아 처리하기 위해 호출하는 함수. doInBackground() 함수에서 publishProgress() 함수로 넘긴 값이 전달된다. |
| onCancelled()                       | 작업을 취소할 때 호출되는 함수                               |

- AsyncTask 실행 및 중지 함수

  | 함수                   | 설명                                                         |
  | ---------------------- | ------------------------------------------------------------ |
  | AsyncTask.execute()    | Asynctack 객체를 실행한다.                                   |
  | AsyncTask.cancel(true) | doInBackground() 함수 실행중에 호출되면 하던 작업을 중단하고 onCencelled() 함수를 호출한다. |


AsyncTask 클래스는 추상클래스 이므로 함수 중 추상함수인 doInBackground()는 꼭 재정의 해서 작성해야 한다.

```java
myAsyncTask.execute();
myAsyncTask.cancel(true);

class MyAsyncTask extends AsyncTask<Void, Integer, String> {

	@Override
	protected String doInBackground(Void... params) {
        ...
        publishProgress(count);
		...
        return "finish";
	}

	@Override
	protected void onPreExecute() {
		super.onPreExecute();
	}

	@Override
	protected void onPostExecute(String s) {
		super.onPostExecute(s);
	}

	@Override
	protected void onProgressUpdate(Integer... values) {
		super.onProgressUpdate(values);
	}

	@Override
	protected void onCancelled() {
		super.onCancelled();
	}
}
```

AsyncTask 클래스를 상속받을 때 타입을 정확하게 지정하고 사용해야 한다. 위의 코드에서는 3가지 타입(Void, Integer, String)를 지정하여 사용하고 있다.

- 첫번째 타입 : 백그라운드 작업을 위한 doInBackground() 함수의 매개변수 타입과 같다. AsyncTask에 의해 백그라운드 작업을 의뢰할 때 넘기는 데이터의 타입이다. 없으면 Void로 지정
- 두번째 타입 : doInBackground() 함수 수행에 의해 발생한 데이터를 publishProgress()함수를 이용해 전달하는데 이때 전달할 데이터 타입이다. 데이터를 계속 전달받는 onProgressUpdate() 함수의 매개변수 타입과 동일하게 지정한다.
- 세번째 타입 : onPostExecute() 함수의 매개변수 타입과 동일하게 지정한다. doInBackground() 함수의 반환형이며 반환된 데이터가 onPostExecute() 함수의 매개변수로 전달된다.

![](/Users/raejin/android-programming-class/class/second/img/16.png)



- 예제 코드

  - MainActivity.java

  ```java
  package com.example.raejin.asynctask;
  
  import android.os.AsyncTask;
  import android.support.v7.app.AppCompatActivity;
  import android.os.Bundle;
  import android.view.View;
  import android.widget.Button;
  import android.widget.ProgressBar;
  import android.widget.TextView;
  import android.widget.Toast;
  
  public class MainActivity extends AppCompatActivity {
  
      int value;
      TextView textView_main;
      ProgressBar progressBar_main;
      Button button_main, button_end;
      MyTask myTask = null;
  
      @Override
      protected void onCreate(Bundle savedInstanceState) {
          super.onCreate(savedInstanceState);
          setContentView(R.layout.activity_main);
  
          textView_main = (TextView)findViewById(R.id.textView_main);
          progressBar_main = (ProgressBar)findViewById(R.id.progressBar_main);
          button_main = (Button)findViewById(R.id.button_main);
          button_end = (Button)findViewById(R.id.button_end);
  
  
  
          button_main.setOnClickListener(new View.OnClickListener() {
              @Override
              public void onClick(View view) {
                  if(myTask == null) {
                      myTask = new MyTask();
                      myTask.execute();
                  } else {
                      Toast.makeText(MainActivity.this, "이미 동작하고 있습니다.",
                              Toast.LENGTH_SHORT).show();
                  }
              }
          });
  
          button_end.setOnClickListener(new View.OnClickListener() {
              @Override
              public void onClick(View view) {
                  if(myTask != null){
                      myTask.cancel(true);
                      myTask = null;
                  }
              }
          });
  
      }
  
      class MyTask extends AsyncTask<Void, Void, Void> {
  
          protected Void doInBackground(Void... argu) {
              while(isCancelled() == false) {
                  value++;
                  if(value <= 1000) {
                      publishProgress();
                  }
                  else {
                      break;
                  }
                  try{
                      Thread.sleep(1000);
                  } catch(Exception e) {}
              }
              return null;
          }
          protected void onPreExecute() {
              value = 0;
              progressBar_main.setVisibility(View.INVISIBLE);
          }
          protected void onPostExecute(Void result) {
              textView_main.setText("1000번을 카운트하였습니다.");
              progressBar_main.setVisibility(View.INVISIBLE);
          }
  
          protected void onProgressUpdate(Void... argu) {
              progressBar_main.setVisibility(View.VISIBLE);
              textView_main.setText(Integer.toString(value));
          }
          protected void onCancelled() {
              textView_main.setText("사용자에 의해 종료되었습니다.");
              progressBar_main.setVisibility(View.INVISIBLE);
          }
      }
  
  
  }
  ```

  - activity_main.xml

  - ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <android.support.constraint.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:app="http://schemas.android.com/apk/res-auto"
        xmlns:tools="http://schemas.android.com/tools"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context="com.example.raejin.asynctask.MainActivity">
    
        <TextView
            android:id="@+id/textView_main"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="Hello World!"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintLeft_toLeftOf="parent"
            app:layout_constraintRight_toRightOf="parent"
            app:layout_constraintTop_toTopOf="parent" />
    
        <ProgressBar
            android:id="@+id/progressBar_main"
            style="?android:attr/progressBarStyle"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_marginTop="8dp"
            android:visibility="invisible"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintHorizontal_bias="0.0"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent"
            app:layout_constraintVertical_bias="0.729" />
    
        <Button
            android:id="@+id/button_main"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginBottom="53dp"
            android:layout_marginEnd="148dp"
            android:layout_marginStart="148dp"
            android:layout_marginTop="146dp"
            android:text="start"
            app:layout_constraintBottom_toTopOf="@+id/textView_main"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent" />
    
        <Button
            android:id="@+id/button_end"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginBottom="44dp"
            android:layout_marginEnd="148dp"
            android:layout_marginStart="148dp"
            android:layout_marginTop="54dp"
            android:text="end"
            app:layout_constraintBottom_toTopOf="@+id/button_main"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent" />
    
    </android.support.constraint.ConstraintLayout>
    
    ```


## 추가내용) 프로그래스 바 (ProgressBar)

프로그래스바는 사용자에게 일의 진행 사항을 표시하기 위한 뷰이다. 프로그래스 바는 화면에서 파일을 내려받는 등 많은 시간이 걸리는 일을 처리할 때, 사용자에게 작업 중이라는 것을 표현하거나 일의 친척사항을 시각적으로 표시하기 때문에 직관적이다. 프로그래스바는 두가지 타입이 존재한다.

​	원형 타입 : 작업의 시작과 끝을 정확히 알 수 없는 경우 (예시 : 다운로드, 업로드)

​	막대 타입(Horizontal) : 작업의 시작과 끝을 정확히 알 수 있는 경우 (예시 : 동영상 혹은 음악파일의 진행바)



- 원형 타입

```xml
    <ProgressBar
        android:id="@+id/progressBar3"
        style="?android:attr/progressBarStyle"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content" />
```

원형타입은 배치하면 무한적으로 동작하기 때문에 별도의 처리가 필요없다. 처음에는 Visible 속성을 gone 혹은 invisible로 설정하다가 작업이 시작되면 visible로 설정하여 프로그래스 바를 표현한다. 이후 작업이 완료되면 다시 Visible 속성을 gone 혹은 invisible로 지정하여 프로그래스바를 숨기는 형태로 활용하게 된다.



- 막대 타입

막대 타입의 경우 작업의 시작, 진행, 끝을 정확히 알 수 있는 경우에 활용되므로 다음 함수들로 값을 표시한다. 

| 함수                                   | 설명                                                         |
| -------------------------------------- | ------------------------------------------------------------ |
| setProgress(int progress)              | 프로그래스 바에 표시되는 값을 지정한다.                      |
| incrementProgressBy(int diff)          | 매개변수 값을 현재 값에서 더하거나 뺄때 사용한다.            |
| setSeconderyProgress(int progress)     | 프로그래스 바에 표시되는 두번째 값을 지정한다.               |
| incrementSecondaryProgressBy(int diff) | 두번째 표시되는 값을 매개변수 값 만큼 더하거나 뺄때 사용한다. |
| setMax(int max)                        | 프로그래스 바에 표시되는 최대값을 지정한다.                  |

막대 타입의 프로그래스 바는 작업의 진행사항을 즉시 반영하여 보여준다. 따라서 별도의 스레드-핸들러 혹은 AsyncTask 등을 활용하여 작업의 진행 정도에 따라 값을 변화시켜주어야 한다.



-  예제 코드

  - MainActivity.java

  ```java
  public class MainActivity extends AppCompatActivity {
  
      ProgressBar pb_circle, pb_bar;
      Button btn_start, btn_stop;
      MyAsyncTask myAsyncTask = null;
  
      @Override
      protected void onCreate(Bundle savedInstanceState) {
          super.onCreate(savedInstanceState);
          setContentView(R.layout.activity_main);
  
          pb_circle = (ProgressBar)findViewById(R.id.pb_circle);
          pb_bar = (ProgressBar)findViewById(R.id.pb_bar);
          btn_start = (Button)findViewById(R.id.btn_start);
          btn_stop = (Button)findViewById(R.id.btn_stop);
  
          pb_circle.setVisibility(View.VISIBLE);
  
          btn_stop.setOnClickListener(new myBtnListener());
          btn_start.setOnClickListener(new myBtnListener());
      }
  
      class myBtnListener implements View.OnClickListener {
          @Override
          public void onClick(View view) {
              switch(view.getId()) {
                  case R.id.btn_start:
                      if(myAsyncTask == null){
                          myAsyncTask = new MyAsyncTask();
                          myAsyncTask.execute();
                      }
                      break;
                  case R.id.btn_stop:
                      if(myAsyncTask != null){
                          myAsyncTask.cancel(true);
                          myAsyncTask = null;
                      }
                      break;
              }
          }
      }
  
      class MyAsyncTask extends AsyncTask<Void, Integer, Void> {
          int value;
  
          @Override
          protected Void doInBackground(Void... voids) {
              while(isCancelled() == false) {
                  value++;
  
                  SystemClock.sleep(10);
  
                  if(value <= 100) {
                      publishProgress(value);
                  } else {
                      break;
                  }
              }
              return null;
          }
  
          @Override
          protected void onPreExecute() {
              value = 0;
              pb_bar.setMax(100);
              pb_bar.setProgress(0);
          }
  
          @Override
          protected void onPostExecute(Void aVoid) {
              Toast.makeText(MainActivity.this, "100% 완료 되었습니다.",
                      Toast.LENGTH_SHORT).show();
          }
  
          @Override
          protected void onProgressUpdate(Integer... values) {
              pb_bar.setProgress(values[0]);
              Log.d("my_onProgressUpdate", values[0].toString());
          }
  
          @Override
          protected void onCancelled() {
              pb_bar.setProgress(0);
          }
      }
  }
  
  ```

  - activity_main.xml

  ```xml
  <?xml version="1.0" encoding="utf-8"?>
  <android.support.constraint.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
      xmlns:app="http://schemas.android.com/apk/res-auto"
      xmlns:tools="http://schemas.android.com/tools"
      android:layout_width="match_parent"
      android:layout_height="match_parent"
      tools:context=".MainActivity">
  
      <ProgressBar
          android:id="@+id/pb_bar"
          style="?android:attr/progressBarStyleHorizontal"
          android:layout_width="0dp"
          android:layout_height="wrap_content"
          app:layout_constraintBottom_toBottomOf="parent"
          app:layout_constraintEnd_toEndOf="parent"
          app:layout_constraintHorizontal_bias="0.5"
          app:layout_constraintStart_toStartOf="parent"
          app:layout_constraintTop_toTopOf="parent" />
  
      <ProgressBar
          android:id="@+id/pb_circle"
          style="?android:attr/progressBarStyle"
          android:layout_width="wrap_content"
          android:layout_height="wrap_content"
          app:layout_constraintBottom_toBottomOf="parent"
          app:layout_constraintEnd_toEndOf="parent"
          app:layout_constraintStart_toStartOf="parent"
          app:layout_constraintTop_toTopOf="parent"
          app:layout_constraintVertical_bias="0.365" />
  
      <Button
          android:id="@+id/btn_start"
          android:layout_width="wrap_content"
          android:layout_height="wrap_content"
          android:text="START"
          app:layout_constraintBottom_toBottomOf="parent"
          app:layout_constraintEnd_toEndOf="parent"
          app:layout_constraintHorizontal_bias="0.165"
          app:layout_constraintStart_toStartOf="parent"
          app:layout_constraintTop_toTopOf="parent"
          app:layout_constraintVertical_bias="0.755" />
  
      <Button
          android:id="@+id/btn_stop"
          android:layout_width="wrap_content"
          android:layout_height="wrap_content"
          android:text="stop"
          app:layout_constraintBottom_toBottomOf="parent"
          app:layout_constraintEnd_toEndOf="parent"
          app:layout_constraintHorizontal_bias="0.827"
          app:layout_constraintStart_toStartOf="parent"
          app:layout_constraintTop_toTopOf="parent"
          app:layout_constraintVertical_bias="0.755" />
  
  
  </android.support.constraint.ConstraintLayout>
  ```


