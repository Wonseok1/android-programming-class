# 07. 스레드와 애니메이션

## 07-4 AsyncTask 사용하기

안드로이드에서는 스레드를 만들어서 직접 UI객체를 수정할 수 없다. 그 이유는 네트워크 요청 같이 대기시간이 길어지는 기능을 수행하면 화면에 보이는 UI가 멈춤 상태가 되어버리기 때문이다. 따라서 스레드와 헨들러를 연결하여 간접적으로 UI를 수정하지만, 다소 코드가 복잡해지게 된다. AsyncTask는 백그라운드 작업을 수행하면서 UI를 수정할 수 있는 코드를 정의할 수 있는 장점이 있다. 



- 주요 함수 (클래스)

| 함수                                | 설명                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| doInBackground(Params... params)    | 스레드에 의해 처리될 내용을 담기 위한 함수                   |
| onPreExecute()                      | AsyncTask의 작업을 시작하기 전에 호출하는 함수,  함수들중 가장 먼저 호출된다. |
| onPostExecute(Result result)        | AsyncTask의 모든 작업이 완료된 후 가장 마지막에 한번 호출되는 함수. doInBackground() 함수의 최종 값을 받기 위해 사용 |
| onProgressUpdate(Progress... value) | doInBackground() 함수에 의해 처리되는 중간중간 값을 받아 처리하기 위해 호출하는 함수. doInBackground() 함수에서 publishProgress() 함수로 넘긴 값이 전달된다. |
| onCancelled()                       | 작업을 취소할 때 호출되는 함수                               |

- 실행 및 중지 함수

  | 함수                   | 설명                                                         |
  | ---------------------- | ------------------------------------------------------------ |
  | AsyncTask.execute()    | Asynctack 객체를 실행한다.                                   |
  | AsyncTask.cancel(true) | doInBackground() 함수 실행중에 호출되면 하던 작업을 중단하고 onCencelled() 함수를 호출한다. |


AsyncTask 클래스는 추상클래스 이므로 함수 중 추상함수인 doInBackground()는 꼭 재정의 해서 작성해야 한다.

```java
myAsyncTask.execute();
myAsyncTask.cancel(true);

class MyAsyncTask extends AsyncTask<Void, Integer, String> {

	@Override
	protected String doInBackground(Void... params) {
        ...
        publishProgress(count);
		...
        return "finish";
	}

	@Override
	protected void onPreExecute() {
		super.onPreExecute();
	}

	@Override
	protected void onPostExecute(String s) {
		super.onPostExecute(s);
	}

	@Override
	protected void onProgressUpdate(Integer... values) {
		super.onProgressUpdate(values);
	}

	@Override
	protected void onCancelled() {
		super.onCancelled();
	}
}
```

AsyncTask 클래스를 상속받을 때 타입을 정확하게 지정하고 사용해야 한다. 위의 코드에서는 3가지 타입(Void, Integer, String)를 지정하여 사용하고 있다.

- 첫번째 타입 : 백그라운드 작업을 위한 doInBackground() 함수의 매개변수 타입과 같다. AsyncTask에 의해 백그라운드 작업을 의뢰할 때 넘기는 데이터의 타입이다. 없으면 Void로 지정
- 두번째 타입 : doInBackground() 함수 수행에 의해 발생한 데이터를 publishProgress()함수를 이용해 전달하는데 이때 전달할 데이터 타입이다. 데이터를 계속 전달받는 onProgressUpdate() 함수의 매개변수 타입과 동일하게 지정한다.
- 세번째 타입 : onPostExecute() 함수의 매개변수 타입과 동일하게 지정한다. doInBackground() 함수의 반환형이며 반환된 데이터가 onPostExecute() 함수의 매개변수로 전달된다.

![](/Users/raejin/android-programming-class/class/second/img/16.png)



- 예제 코드

  - MainActivity.java

  ```java
  package com.example.raejin.asynctask;
  
  import android.os.AsyncTask;
  import android.support.v7.app.AppCompatActivity;
  import android.os.Bundle;
  import android.view.View;
  import android.widget.Button;
  import android.widget.ProgressBar;
  import android.widget.TextView;
  import android.widget.Toast;
  
  public class MainActivity extends AppCompatActivity {
  
      int value;
      TextView textView_main;
      ProgressBar progressBar_main;
      Button button_main, button_end;
      MyTask myTask = null;
  
      @Override
      protected void onCreate(Bundle savedInstanceState) {
          super.onCreate(savedInstanceState);
          setContentView(R.layout.activity_main);
  
          textView_main = (TextView)findViewById(R.id.textView_main);
          progressBar_main = (ProgressBar)findViewById(R.id.progressBar_main);
          button_main = (Button)findViewById(R.id.button_main);
          button_end = (Button)findViewById(R.id.button_end);
  
  
  
          button_main.setOnClickListener(new View.OnClickListener() {
              @Override
              public void onClick(View view) {
                  if(myTask == null) {
                      myTask = new MyTask();
                      myTask.execute();
                  } else {
                      Toast.makeText(MainActivity.this, "이미 동작하고 있습니다.",
                              Toast.LENGTH_SHORT).show();
                  }
              }
          });
  
          button_end.setOnClickListener(new View.OnClickListener() {
              @Override
              public void onClick(View view) {
                  if(myTask != null){
                      myTask.cancel(true);
                      myTask = null;
                  }
              }
          });
  
      }
  
      class MyTask extends AsyncTask<Void, Void, Void> {
  
          protected Void doInBackground(Void... argu) {
              while(isCancelled() == false) {
                  value++;
                  if(value <= 1000) {
                      publishProgress();
                  }
                  else {
                      break;
                  }
                  try{
                      Thread.sleep(1000);
                  } catch(Exception e) {}
              }
              return null;
          }
          protected void onPreExecute() {
              value = 0;
              progressBar_main.setVisibility(View.INVISIBLE);
          }
          protected void onPostExecute(Void result) {
              textView_main.setText("1000번을 카운트하였습니다.");
              progressBar_main.setVisibility(View.INVISIBLE);
          }
  
          protected void onProgressUpdate(Void... argu) {
              progressBar_main.setVisibility(View.VISIBLE);
              textView_main.setText(Integer.toString(value));
          }
          protected void onCancelled() {
              textView_main.setText("사용자에 의해 종료되었습니다.");
              progressBar_main.setVisibility(View.INVISIBLE);
          }
      }
  
  
  }
  ```

  - activity_main.xml

  - ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <android.support.constraint.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:app="http://schemas.android.com/apk/res-auto"
        xmlns:tools="http://schemas.android.com/tools"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context="com.example.raejin.asynctask.MainActivity">
    
        <TextView
            android:id="@+id/textView_main"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="Hello World!"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintLeft_toLeftOf="parent"
            app:layout_constraintRight_toRightOf="parent"
            app:layout_constraintTop_toTopOf="parent" />
    
        <ProgressBar
            android:id="@+id/progressBar_main"
            style="?android:attr/progressBarStyle"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_marginTop="8dp"
            android:visibility="invisible"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintHorizontal_bias="0.0"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent"
            app:layout_constraintVertical_bias="0.729" />
    
        <Button
            android:id="@+id/button_main"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginBottom="53dp"
            android:layout_marginEnd="148dp"
            android:layout_marginStart="148dp"
            android:layout_marginTop="146dp"
            android:text="start"
            app:layout_constraintBottom_toTopOf="@+id/textView_main"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent" />
    
        <Button
            android:id="@+id/button_end"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginBottom="44dp"
            android:layout_marginEnd="148dp"
            android:layout_marginStart="148dp"
            android:layout_marginTop="54dp"
            android:text="end"
            app:layout_constraintBottom_toTopOf="@+id/button_main"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent" />
    
    </android.support.constraint.ConstraintLayout>
    
    ```
